<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ireneo Demo: TodoMVC with Mutation Sourcing</title>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const G=(t="ireneo",e="events")=>{let n,r=!1;const s=new Promise((a,o)=>{if(typeof indexedDB>"u"){o(new Error("IndexedDB not available (browser only)"));return}const c=indexedDB.open(t);c.onerror=()=>o(c.error),c.onsuccess=()=>{const l=c.result,d=l.objectStoreNames.contains(e),f=l.version;if(l.close(),d){const u=indexedDB.open(t,f);u.onerror=()=>o(u.error),u.onsuccess=()=>{n=u.result,a()}}else{const u=indexedDB.open(t,f+1);u.onerror=()=>o(u.error),u.onsuccess=()=>{n=u.result,a()},u.onupgradeneeded=y=>{const E=y.target.result;E.objectStoreNames.contains(e)||E.createObjectStore(e,{autoIncrement:!0})}}},c.onupgradeneeded=l=>{const d=l.target.result;d.objectStoreNames.contains(e)||d.createObjectStore(e,{autoIncrement:!0})}}),i=()=>{if(r)throw new Error(`EventLog (${e}) has been closed and cannot be used. This usually happens when switching between memory images.`)};return{append:async a=>(i(),await s,new Promise((o,c)=>{const f=n.transaction([e],"readwrite").objectStore(e).add(a);f.onsuccess=()=>o(),f.onerror=()=>c(f.error)})),getAll:async()=>(i(),await s,new Promise((a,o)=>{const d=n.transaction([e],"readonly").objectStore(e).getAll();d.onsuccess=()=>a(d.result),d.onerror=()=>o(d.error)})),clear:async()=>(i(),await s,new Promise((a,o)=>{const d=n.transaction([e],"readwrite").objectStore(e).clear();d.onsuccess=()=>a(),d.onerror=()=>o(d.error)})),close:async()=>{if(!r){r=!0;try{await s,n&&(n.close(),await new Promise(a=>setTimeout(a,50)))}catch(a){console.warn(`EventLog close(): Database was never initialized (${e})`,a)}}}}};class J{constructor(){this.delta=new Map,this.DELETED=Symbol("deleted")}getDeletedSymbol(){return this.DELETED}isDirty(){return this.delta.size>0}size(){return this.delta.size}has(e){return this.delta.has(e)}get(e){return this.delta.get(e)}set(e,n){this.delta.set(e,n)}delete(e){this.delta.set(e,this.DELETED)}isDeleted(e){return this.delta.get(e)===this.DELETED}clear(){this.delta.clear()}entries(){return Array.from(this.delta.entries()).sort((e,n)=>{const r=e[0].split(".").length,s=n[0].split(".").length;return r-s})}createCheckpoint(){return new Map(this.delta)}restoreCheckpoint(e){this.delta.clear();for(const[n,r]of e)this.delta.set(n,r)}}function X(t){return t!==null&&typeof t=="object"}function T(t,e,n=new WeakMap){if(!X(t))return t;if(n.has(t))return n.get(t);const r=e.has(t)?e.get(t):t;if(r!==t&&n.has(r)){const o=n.get(r);return n.set(t,o),o}if(r instanceof Map){const o=new Map;n.set(t,o),r!==t&&n.set(r,o);let c=!1;for(const[d,f]of r.entries()){const u=T(d,e,n),y=T(f,e,n);o.set(u,y),(u!==d||y!==f)&&(c=!0)}const l=c?o:r;return n.set(t,l),r!==t&&n.set(r,l),l}if(r instanceof Set){const o=new Set;n.set(t,o),r!==t&&n.set(r,o);let c=!1;for(const d of r.values()){const f=T(d,e,n);o.add(f),f!==d&&(c=!0)}const l=c?o:r;return n.set(t,l),r!==t&&n.set(r,l),l}if(Array.isArray(r)){const o=[];n.set(t,o),r!==t&&n.set(r,o);let c=!1;for(const d of r){const f=T(d,e,n);o.push(f),f!==d&&(c=!0)}const l=c?o:r;return n.set(t,l),r!==t&&n.set(r,l),l}const s={};n.set(t,s),r!==t&&n.set(r,s);let i=!1;for(const[o,c]of Object.entries(r)){const l=T(c,e,n);s[o]=l,l!==c&&(i=!0)}const a=i?s:r;return n.set(t,a),r!==t&&n.set(r,a),a}function H(t){return t!==null&&typeof t=="object"}function Y(t,e,n,r,s){if(r.has(t))return r.get(t);const i=e.getDeletedSymbol(),a=new Proxy(t,{get(o,c){if(typeof c=="symbol")return o[c];const l=[...n,String(c)],d=l.join(".");if(e.has(d)){const u=e.get(d);return u===i?void 0:H(u)?s.has(u)?u:Y(u,e,l,r,s):u}const f=o[c];if(typeof f=="function"&&Array.isArray(o)){const u=String(c);return["push","pop","shift","unshift","splice","sort","reverse"].includes(u)?function(...E){const S=n.join(".");let h;return e.has(S)?h=e.get(S):(h=[...o],e.set(S,h)),f.apply(h,E)}:f.bind(o)}return H(f)?s.has(f)?f:Y(f,e,l,r,s):f},set(o,c,l){const f=[...n,String(c)].join(".");return e.set(f,l),!0},has(o,c){const d=[...n,String(c)].join(".");return e.has(d)?e.get(d)!==i:c in o},deleteProperty(o,c){const d=[...n,String(c)].join(".");return e.delete(d),!0},ownKeys(o){const c=Reflect.ownKeys(o),l=n.length>0?n.join(".")+".":"",d=new Set;for(const[u,y]of e.entries())if(u.startsWith(l)){const E=u.slice(l.length),S=E.indexOf("."),h=S===-1?E:E.slice(0,S);y!==i&&d.add(h)}const f=new Set(c);for(const[u,y]of e.entries())if(u.startsWith(l)){const E=u.slice(l.length);if(E.indexOf(".")===-1){const h=E;y===i?f.delete(h):f.add(h)}}return Array.from(f)},getOwnPropertyDescriptor(o,c){const d=[...n,String(c)].join(".");if(e.has(d)){const f=e.get(d);return f===i?void 0:{value:f,writable:!0,enumerable:!0,configurable:!0}}return Reflect.getOwnPropertyDescriptor(o,c)}});return r.set(t,a),s.set(a,t),a}const p={SET:"SET",DELETE:"DELETE",ARRAY_PUSH:"ARRAY_PUSH",ARRAY_POP:"ARRAY_POP",ARRAY_SHIFT:"ARRAY_SHIFT",ARRAY_UNSHIFT:"ARRAY_UNSHIFT",ARRAY_SPLICE:"ARRAY_SPLICE",ARRAY_SORT:"ARRAY_SORT",ARRAY_REVERSE:"ARRAY_REVERSE",ARRAY_FILL:"ARRAY_FILL",ARRAY_COPYWITHIN:"ARRAY_COPYWITHIN",MAP_SET:"MAP_SET",MAP_DELETE:"MAP_DELETE",MAP_CLEAR:"MAP_CLEAR",SET_ADD:"SET_ADD",SET_DELETE:"SET_DELETE",SET_CLEAR:"SET_CLEAR",SCRIPT:"SCRIPT"},R={TYPE:"__type__",CLASS:"__class__",DATE_VALUE:"__dateValue__"};var g=(t=>(t[t.NULL=0]="NULL",t[t.UNDEFINED=1]="UNDEFINED",t[t.PRIMITIVE=2]="PRIMITIVE",t[t.BIGINT=3]="BIGINT",t[t.SYMBOL=4]="SYMBOL",t[t.DATE=5]="DATE",t[t.REGEXP=6]="REGEXP",t[t.FUNCTION=7]="FUNCTION",t[t.ARRAY=8]="ARRAY",t[t.MAP=9]="MAP",t[t.SET=10]="SET",t[t.OBJECT=11]="OBJECT",t))(g||{});function Q(t){if(t===null)return{category:0,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!1};if(t===void 0)return{category:1,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!1};const e=typeof t;return e==="string"||e==="number"||e==="boolean"?{category:2,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!1}:e==="bigint"?{category:3,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!0}:e==="symbol"?{category:4,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!0}:t instanceof Date?{category:5,isPrimitive:!1,isObject:!0,isCollection:!1,needsSpecialSerialization:!0}:t instanceof RegExp?{category:6,isPrimitive:!1,isObject:!0,isCollection:!1,needsSpecialSerialization:!0}:e==="function"?{category:7,isPrimitive:!1,isObject:!0,isCollection:!1,needsSpecialSerialization:!0}:Array.isArray(t)?{category:8,isPrimitive:!1,isObject:!0,isCollection:!0,needsSpecialSerialization:!1}:t instanceof Map?{category:9,isPrimitive:!1,isObject:!0,isCollection:!0,needsSpecialSerialization:!0}:t instanceof Set?{category:10,isPrimitive:!1,isObject:!0,isCollection:!0,needsSpecialSerialization:!0}:{category:11,isPrimitive:!1,isObject:!0,isCollection:!1,needsSpecialSerialization:!1}}function Z(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return!(e===null||e===Object.prototype||t instanceof Date||t instanceof RegExp||t instanceof Map||t instanceof Set||t instanceof Array||t instanceof Error||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)}function ee(t){const e=Object.getPrototypeOf(t);if(!e||e===Object.prototype)return null;const n=e.constructor;return!n||!n.name?null:n.name}class te{constructor(e,n){this.targetToPath=e,this.currentPath=n,this.seen=new Map}hasSeen(e){return this.seen.has(e)}markSeen(e,n){this.seen.set(e,n)}getReference(e){const n=this.targetToPath.get(e);return n&&n.length>0&&!(n.length>=this.currentPath.length&&this.currentPath.every((s,i)=>s===n[i]))?{__type__:"ref",path:n}:this.hasSeen(e)?{__type__:"ref",path:this.seen.get(e).slice(this.currentPath.length)}:null}}function v(t,e,n,r){const s=typeof t=="object"&&t!==null&&r.get(t)||t,i=Q(s);switch(i.category){case g.NULL:case g.UNDEFINED:return t;case g.PRIMITIVE:return t;case g.BIGINT:return{[R.TYPE]:"bigint",value:t.toString()};case g.SYMBOL:return{[R.TYPE]:"symbol",description:t.description};case g.DATE:{const a=r.get(t)||t,o=n.getReference(a);if(o)return o;n.markSeen(a,e);const c=a,l=c.getTime(),d=isNaN(l)?null:c.toISOString(),f={[R.TYPE]:"date",[R.DATE_VALUE]:d},u=Object.entries(c);for(const[y,E]of u)f[y]=v(E,[...e,y],n,r);return f}case g.REGEXP:{const a=r.get(t)||t,o=n.getReference(a);if(o)return o;n.markSeen(a,e);const c=a;return{[R.TYPE]:"regexp",source:c.source,flags:c.flags,lastIndex:c.lastIndex}}case g.FUNCTION:{const a=t;return a.__type__==="function"?{[R.TYPE]:"function",sourceCode:a.sourceCode||t.toString()}:void 0}case g.MAP:case g.SET:case g.ARRAY:case g.OBJECT:{const a=r.get(t)||t,o=n.getReference(a);if(o)return o;if(n.markSeen(a,e),i.category===g.MAP)return{[R.TYPE]:"map",entries:Array.from(a.entries()).map(([d,f],u)=>[v(d,[...e,"key",String(u)],n,r),v(f,[...e,"value",String(u)],n,r)])};if(i.category===g.SET)return{[R.TYPE]:"set",values:Array.from(a.values()).map((d,f)=>v(d,[...e,String(f)],n,r))};if(i.category===g.ARRAY)return t.map((d,f)=>v(d,[...e,String(f)],n,r));const c={},l=t;if(Z(a)){const d=ee(a);d&&(c[R.CLASS]=d)}for(const d in l)Object.prototype.hasOwnProperty.call(l,d)&&(c[d]=v(l[d],[...e,d],n,r));return c}default:return}}const A=(t,e,n,r)=>{const s=new te(n,r);return v(t,r,s,e)},ne=t=>typeof t=="object"&&t!==null&&"__type__"in t&&typeof t.__type__=="string",F=t=>{const n=new Function(`return (${t.sourceCode})`)();return n.__type__="function",n.sourceCode=t.sourceCode,n},j=(t,e,n)=>{if(!("__dateValue__"in t))throw new Error("Invalid Date serialization format: missing __dateValue__ field");const r=t.__dateValue__,s=r===null?new Date("invalid"):new Date(r);for(const[i,a]of Object.entries(t))i==="__type__"||i==="__dateValue__"||(s[i]=e(a,n));return s},U=t=>{const e=new RegExp(t.source,t.flags);return t.lastIndex!==void 0&&(e.lastIndex=t.lastIndex),e},K=t=>BigInt(t.value),V=t=>Symbol(t.description),O=t=>typeof t=="object"&&t!==null&&"__unresolved_ref__"in t,re=(t,e)=>{const n=new Map;for(const[r,s]of t.entries){const i=typeof r=="object"&&r!==null&&r.__type__&&P[r.__type__]?.(r,e)||r,a=typeof s=="object"&&s!==null&&s.__type__&&P[s.__type__]?.(s,e)||s;n.set(i,a)}return n},se=(t,e)=>{const n=new Set;for(const r of t.values){const s=typeof r=="object"&&r!==null&&r.__type__&&P[r.__type__]?.(r,e)||r;n.add(s)}return n},P={function:t=>F(t),date:(t,e)=>j(t,(r,s)=>{if(r&&typeof r=="object"&&"__type__"in r){const i=P[r.__type__];return i?i(r,e):r}return r},e),regexp:t=>U(t),bigint:t=>K(t),symbol:t=>V(t),ref:t=>({__unresolved_ref__:t.path}),map:(t,e)=>re(t,e),set:(t,e)=>se(t,e)};function oe(t,e,n){const r=[];function s(a,o=[]){if(a===null||typeof a!="object")return a;if(a.__type__&&P[a.__type__]){const c=P[a.__type__];if(!c)return a;const l=c(a,t);if(l&&O(l))return r.push({parent:null,key:null,path:l.__unresolved_ref__}),l;if(l instanceof Date){for(const d in l)if(Object.prototype.hasOwnProperty.call(l,d)){const f=l[d];f&&O(f)&&r.push({parent:l,key:d,path:f.__unresolved_ref__})}}return l}for(const c in a)if(Object.prototype.hasOwnProperty.call(a,c)){const l=a[c];if(l&&typeof l=="object")if(l.__type__&&P[l.__type__]){const d=P[l.__type__];if(!d)continue;const f=d(l,t);if(f&&O(f))r.push({parent:a,key:c,path:f.__unresolved_ref__});else if(a[c]=f,f instanceof Date){for(const u in f)if(Object.prototype.hasOwnProperty.call(f,u)){const y=f[u];y&&O(y)&&r.push({parent:f,key:u,path:y.__unresolved_ref__})}}}else{const d=s(l,[...o,c]);d!==l&&(a[c]=d)}}return a}let i=s(t);for(const a of r){const{parent:o,key:c,path:l}=a,d=e(l,i);o&&c!==null?o[c]=d:o===null&&c===null&&(i=d)}return i}function ie(t,e,n){return oe(t,(i,a)=>{let o=a,c=!0;for(const l of i){const d=o?.[l];if(d===void 0){c=!1;break}o=d}if(c)return o;o=e;for(const l of i){const d=o?.[l];if(d===void 0)throw new Error(`Cannot resolve event value ref path: ${i.join(".")} (not found in value scope or memory scope)`);o=d}return o})}const w=(t,e,n=new WeakMap,r)=>{if(t==null||typeof t!="object")return t;if(n.has(t))return n.get(t);if(ne(t)){const i=t;switch(i.__type__){case"function":return F(i);case"date":return j(i,(c,l)=>w(c,e,n),e);case"regexp":return U(i);case"bigint":return K(i);case"symbol":return V(i);case"ref":{const a=i;let o=e;for(const c of a.path)if(o=o[c],o===void 0)throw new Error(`Cannot resolve ref path: ${a.path.join(".")}`);return o}case"map":{const a=i,o=new Map;n.set(t,o);for(const[c,l]of a.entries){const d=w(c,e,n),f=w(l,e,n);o.set(d,f)}return o}case"set":{const a=i,o=new Set;n.set(t,o);for(const c of a.values)o.add(w(c,e,n));return o}case"circular":throw new Error("Encountered explicit circular marker - this indicates a serialization issue")}}if(Array.isArray(t)){const i=[];n.set(t,i);for(const a of t)i.push(w(a,e,n));return i}const s={};n.set(t,s);for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(s[i]=w(t[i],e,n));return s};class ae{createEvent(e,n,r){const[s]=n;return{type:p.SET,path:e,value:A(s,r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e;n[r]=ie(i.value,s)}}class ce{createEvent(e){return{type:p.DELETE,path:e,timestamp:Date.now()}}applyEvent(e,n,r){delete n[r]}}class le{createEvent(e,n,r){return{type:p.ARRAY_PUSH,path:e,items:n.map(s=>A(s,r.proxyToTarget,r.targetToPath,e)),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,a=n[r];for(const o of i.items)a.push(w(o,s))}}class de{createEvent(e){return{type:p.ARRAY_POP,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].pop()}}class fe{createEvent(e){return{type:p.ARRAY_SHIFT,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].shift()}}class ue{createEvent(e,n,r){return{type:p.ARRAY_UNSHIFT,path:e,items:n.map(s=>A(s,r.proxyToTarget,r.targetToPath,e)),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,a=n[r],o=i.items.map(c=>w(c,s));a.unshift(...o)}}class pe{createEvent(e,n,r){return{type:p.ARRAY_SPLICE,path:e,start:n[0],deleteCount:n[1]||0,items:n.slice(2).map(s=>A(s,r.proxyToTarget,r.targetToPath,e)),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,a=n[r],o=i.items.map(c=>w(c,s));a.splice(i.start,i.deleteCount,...o)}}class ye{createEvent(e){return{type:p.ARRAY_SORT,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].sort()}}class Ee{createEvent(e){return{type:p.ARRAY_REVERSE,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].reverse()}}class _e{createEvent(e,n,r){return{type:p.ARRAY_FILL,path:e,value:A(n[0],r.proxyToTarget,r.targetToPath,e),start:n[1],end:n[2],timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,a=n[r],o=w(i.value,s);a.fill(o,i.start,i.end)}}class me{createEvent(e,n){return{type:p.ARRAY_COPYWITHIN,path:e,target:n[0],start:n[1],end:n[2],timestamp:Date.now()}}applyEvent(e,n,r){const s=e;n[r].copyWithin(s.target,s.start,s.end)}}class he{createEvent(e,n,r){return{type:p.MAP_SET,path:e,key:A(n[0],r.proxyToTarget,r.targetToPath,e),value:A(n[1],r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,a=n[r],o=w(i.key,s),c=w(i.value,s);a.set(o,c)}}class ge{createEvent(e,n,r){return{type:p.MAP_DELETE,path:e,key:A(n[0],r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,a=n[r],o=w(i.key,s);a.delete(o)}}class we{createEvent(e){return{type:p.MAP_CLEAR,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].clear()}}class Ae{createEvent(e,n,r){return{type:p.SET_ADD,path:e,value:A(n[0],r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,a=n[r],o=w(i.value,s);a.add(o)}}class Se{createEvent(e,n,r){return{type:p.SET_DELETE,path:e,value:A(n[0],r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,a=n[r],o=w(i.value,s);a.delete(o)}}class Re{createEvent(e){return{type:p.SET_CLEAR,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].clear()}}class Pe{createEvent(e,n){return{type:p.SCRIPT,path:e,source:n[0],timestamp:Date.now()}}applyEvent(){}}class ve{constructor(){this.handlers=new Map}register(e,n){this.handlers.set(e,n)}createEvent(e,n,r,s){const i=this.handlers.get(e);if(!i)throw new Error(`No handler registered for event type: ${e}`);return i.createEvent(n,r,s)}applyEvent(e,n,r,s){const i=this.handlers.get(e.type);if(!i)throw new Error(`No handler registered for event type: ${e.type}`);i.applyEvent(e,n,r,s)}hasHandler(e){return this.handlers.has(e)}}const _=new ve;_.register(p.SET,new ae);_.register(p.DELETE,new ce);_.register(p.ARRAY_PUSH,new le);_.register(p.ARRAY_POP,new de);_.register(p.ARRAY_SHIFT,new fe);_.register(p.ARRAY_UNSHIFT,new ue);_.register(p.ARRAY_SPLICE,new pe);_.register(p.ARRAY_SORT,new ye);_.register(p.ARRAY_REVERSE,new Ee);_.register(p.ARRAY_FILL,new _e);_.register(p.ARRAY_COPYWITHIN,new me);_.register(p.MAP_SET,new he);_.register(p.MAP_DELETE,new ge);_.register(p.MAP_CLEAR,new we);_.register(p.SET_ADD,new Ae);_.register(p.SET_DELETE,new Se);_.register(p.SET_CLEAR,new Re);_.register(p.SCRIPT,new Pe);const C=(t,e)=>{let n=t;for(let s=0;s<e.path.length-1;s++){const i=e.path[s];if(i){if(!(i in n)){const a=e.path[s+1];n[i]=a&&/^\d+$/.test(a)?[]:{}}n=n[i]}}const r=e.path[e.path.length-1];r&&_.applyEvent(e,n,r,t)},k=async(t,e,n)=>{if(n.isReplaying=!0,Array.isArray(e))for(const r of e)C(t,r);else for await(const r of e)C(t,r);n.isReplaying=!1},Te=async(t,e,n)=>{if(e.stream)await k(t,e.stream(),n);else{const r=await e.getAll();await k(t,r,n)}};async function W(t){const e=new J,n=e.getDeletedSymbol(),r=new WeakMap,s=new WeakMap,i={};return await Te(i,t,{isReplaying:!0}),{root:Y(i,e,[],r,s),isDirty(){return e.isDirty()},getUncommittedCount(){return e.size()},async save(){const o=e.entries(),c=new WeakMap,l=(d,f,u=[])=>{if(!(f===null||typeof f!="object")&&!d.has(f))if(d.set(f,u),Array.isArray(f))f.forEach((y,E)=>l(d,y,[...u,String(E)]));else if(f instanceof Map){let y=0;f.forEach(E=>l(d,E,[...u,`map:${y++}`]))}else if(f instanceof Set){let y=0;f.forEach(E=>l(d,E,[...u,`set:${y++}`]))}else f instanceof Date||Object.entries(f).forEach(([y,E])=>l(d,E,[...u,y]))};for(const[d,f]of o){const u=new WeakMap;l(u,i);const y=d.split(".");let E=i;for(let h=0;h<y.length-1;h++)E=E[y[h]];const S=y[y.length-1];if(f===n)delete E[S],await t.append({type:"DELETE",path:y,timestamp:Date.now()});else{const h=T(f,s,c),z=A(h,new WeakMap,u,y);E[S]=h,await t.append({type:"SET",path:y,value:z,timestamp:Date.now()})}}e.clear()},discard(){e.clear()},createCheckpoint(){return e.createCheckpoint()},restoreCheckpoint(o){e.restoreCheckpoint(o)},unwrap(o){return T(o,s)}}}let D,I,m;async function B(){try{D=G("ireneo-demo","todos"),I=await W(D),m=I.root,m.todos||(m.todos=[],m.nextId=1);const t=localStorage.getItem("ireneo-demo-theme")||"light";document.documentElement.setAttribute("data-theme",t),q(t),xe(),await L(),console.log("Ireneo demo initialized"),console.log(`Loaded ${m.todos.length} todos from IndexedDB`)}catch(t){console.error("Initialization error:",t),alert("Failed to initialize app. Check console for details.")}}async function N(t){if(!t.trim())return;m.todos.push({id:m.nextId++,text:t.trim(),done:!1,createdAt:new Date}),await M();const e=document.getElementById("new-todo");e&&(e.value=""),await L()}async function De(t){const e=m.todos.find(n=>n.id===t);e&&(e.done=!e.done,await M(),await L())}async function Ie(t){const e=m.todos.findIndex(n=>n.id===t);e>=0&&(m.todos.splice(e,1),await M(),await L())}async function M(){try{await I.save(),x("Saved to IndexedDB","success")}catch(t){console.error("Save error:",t),x("Save failed","error")}}async function Le(){if(confirm("Clear all todos and events? This cannot be undone."))try{m.todos.length=0,m.nextId=1,await I.save(),D.clear&&await D.clear(),I=await W(D),m=I.root,m.todos=[],m.nextId=1,await L(),x("All data cleared","success")}catch(t){console.error("Clear error:",t),x("Clear failed","error")}}async function L(){Oe(),await be()}function Oe(){const t=document.getElementById("todo-list");if(t){if(m.todos.length===0){t.innerHTML='<li class="empty-state" style="text-align: center; color: var(--text-tertiary); padding: 2rem;">No todos yet. Add one above!</li>';return}t.innerHTML=m.todos.map(e=>`
    <li class="todo-item ${e.done?"done":""}">
      <input
        type="checkbox"
        ${e.done?"checked":""}
        onchange="window.toggleTodoAsync(${e.id})"
      />
      <span class="todo-text">${b(e.text)}</span>
      <button class="todo-delete" onclick="window.deleteTodoAsync(${e.id})" title="Delete">×</button>
    </li>
  `).join("")}}async function be(){const t=document.getElementById("event-list"),e=document.getElementById("event-count"),n=document.getElementById("storage-size");if(!(!t||!e||!n))try{const r=await D.getAll();if(r.length===0){t.innerHTML='<div class="empty-state" style="text-align: center; color: var(--text-tertiary); padding: 2rem;">No events yet. Interact with todos to see mutations!</div>',e.textContent="0 events",n.textContent="0 KB";return}const s=r.slice(-50).reverse();t.innerHTML=s.map(o=>{const c=JSON.stringify(o.path);let l="";return o.type==="SET"&&"value"in o?l=`<div class="event-value">value: ${$(o.value)}</div>`:o.type==="ARRAY_PUSH"&&"items"in o?l=`<div class="event-value">pushed: ${$(o.items[0])}</div>`:o.type==="ARRAY_SPLICE"&&"start"in o&&(l=`<div class="event-value">index: ${o.start}, deleted: ${o.deleteCount}</div>`),`
        <div class="event event-${o.type}">
          <span class="event-type">${o.type}</span>
          <div class="event-path">${b(c)}</div>
          ${l}
        </div>
      `}).join(""),e.textContent=`${r.length} event${r.length!==1?"s":""}`;const a=(JSON.stringify(r).length/1024).toFixed(1);n.textContent=`${a} KB`}catch(r){console.error("Error rendering events:",r),t.innerHTML='<div style="color: var(--danger); padding: 1rem;">Error loading events</div>'}}function xe(){const t=document.getElementById("add-btn"),e=document.getElementById("new-todo");t&&e&&(t.addEventListener("click",()=>{N(e.value).catch(console.error)}),e.addEventListener("keypress",s=>{s.key==="Enter"&&N(e.value).catch(console.error)}));const n=document.getElementById("clear-all-btn");n&&n.addEventListener("click",Le);const r=document.getElementById("theme-toggle");r&&r.addEventListener("click",Ye),window.toggleTodoAsync=s=>De(s).catch(console.error),window.deleteTodoAsync=s=>Ie(s).catch(console.error)}function Ye(){const e=(document.documentElement.getAttribute("data-theme")||"light")==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("ireneo-demo-theme",e),q(e)}function q(t){const e=document.getElementById("theme-toggle");e&&(e.textContent=t==="light"?"🌙":"☀️")}function b(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function $(t){return typeof t=="string"?`"${b(t)}"`:b(JSON.stringify(t,null,2))}function x(t,e){console.log(`[${e.toUpperCase()}] ${t}`)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",B):B();</script>
  <style rel="stylesheet" crossorigin>:root{--primary: #4F46E5;--primary-hover: #4338CA;--success: #10B981;--warning: #F59E0B;--danger: #EF4444;--bg-primary: #FFFFFF;--bg-secondary: #F9FAFB;--bg-tertiary: #F3F4F6;--text-primary: #111827;--text-secondary: #6B7280;--text-tertiary: #9CA3AF;--border: #E5E7EB;--border-focus: #4F46E5;--event-push-bg: #D1FAE5;--event-push-border: #10B981;--event-set-bg: #FED7AA;--event-set-border: #F59E0B;--event-delete-bg: #FECACA;--event-delete-border: #EF4444;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .05);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .1);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .1)}[data-theme=dark]{--bg-primary: #1F2937;--bg-secondary: #111827;--bg-tertiary: #374151;--text-primary: #F9FAFB;--text-secondary: #D1D5DB;--text-tertiary: #9CA3AF;--border: #374151;--border-focus: #6366F1;--event-push-bg: #065F46;--event-push-border: #10B981;--event-set-bg: #78350F;--event-set-border: #F59E0B;--event-delete-bg: #7F1D1D;--event-delete-border: #EF4444;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .3);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .4);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .5)}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;color:var(--text-primary);background:var(--bg-secondary);transition:background-color .2s ease,color .2s ease}.container{max-width:1400px;margin:0 auto;padding:2rem 1.5rem}.header{text-align:center;margin-bottom:2rem}.header h1{font-size:2.5rem;font-weight:700;color:var(--text-primary);margin-bottom:.5rem}.header .subtitle{font-size:1rem;color:var(--text-secondary)}.app{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}.panel{background:var(--bg-primary);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-md);overflow:hidden;display:flex;flex-direction:column;min-height:600px}.panel-header{padding:1.5rem;border-bottom:1px solid var(--border);background:var(--bg-secondary)}.panel-header h2{font-size:1.25rem;font-weight:600;color:var(--text-primary);margin:0}.panel-header .subtitle{font-size:.875rem;color:var(--text-secondary);margin-top:.25rem}.panel-content{padding:1.5rem;flex:1;display:flex;flex-direction:column;overflow:hidden}.input-group{display:flex;gap:.5rem;margin-bottom:1.5rem}#new-todo{flex:1;padding:.75rem 1rem;font-size:1rem;border:1px solid var(--border);border-radius:8px;background:var(--bg-primary);color:var(--text-primary);transition:border-color .15s ease,box-shadow .15s ease}#new-todo:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px #4f46e51a}#new-todo::placeholder{color:var(--text-tertiary)}.btn{padding:.75rem 1.25rem;font-size:.875rem;font-weight:500;border:none;border-radius:8px;cursor:pointer;transition:all .15s ease;white-space:nowrap}.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px);box-shadow:var(--shadow-md)}.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border)}.btn-secondary:hover{background:var(--bg-secondary);transform:translateY(-1px)}.btn-success{background:var(--success);color:#fff}.btn-success:hover{background:#059669;transform:translateY(-1px)}.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#dc2626;transform:translateY(-1px)}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}.icon-btn{background:none;border:none;font-size:1.25rem;cursor:pointer;padding:.25rem .5rem;transition:transform .15s ease}.icon-btn:hover{transform:scale(1.1)}.todo-list{list-style:none;flex:1;overflow-y:auto;margin-bottom:1.5rem}.todo-item{display:flex;align-items:center;gap:.75rem;padding:.875rem;border-radius:8px;background:var(--bg-secondary);border:1px solid var(--border);margin-bottom:.5rem;transition:all .15s ease}.todo-item:hover{border-color:var(--primary);box-shadow:var(--shadow-sm)}.todo-item.done .todo-text{text-decoration:line-through;color:var(--text-tertiary)}.todo-item input[type=checkbox]{width:1.25rem;height:1.25rem;cursor:pointer;accent-color:var(--primary)}.todo-text{flex:1;color:var(--text-primary);font-size:.9375rem}.todo-delete{background:var(--danger);color:#fff;border:none;border-radius:4px;width:1.75rem;height:1.75rem;font-size:1.125rem;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s ease}.todo-delete:hover{background:#dc2626;transform:scale(1.1)}.actions{display:flex;gap:.5rem;flex-wrap:wrap}.auto-save-notice{margin-top:.75rem;text-align:center}.event-list{flex:1;overflow-y:auto;margin-bottom:1rem;display:flex;flex-direction:column;gap:.5rem}.event{padding:.75rem 1rem;border-radius:6px;border-left:3px solid;font-size:.875rem;animation:slideIn .3s ease}@keyframes slideIn{0%{opacity:0;transform:translate(-10px)}to{opacity:1;transform:translate(0)}}.event-ARRAY_PUSH{background:var(--event-push-bg);border-color:var(--event-push-border)}.event-SET{background:var(--event-set-bg);border-color:var(--event-set-border)}.event-ARRAY_SPLICE,.event-DELETE{background:var(--event-delete-bg);border-color:var(--event-delete-border)}.event-type{font-weight:600;font-family:Monaco,Courier New,monospace;font-size:.8125rem;display:inline-block;margin-right:.5rem}.event-path{font-family:Monaco,Courier New,monospace;font-size:.75rem;color:var(--text-secondary);display:block;margin-top:.25rem;word-break:break-all}.event-value{font-family:Monaco,Courier New,monospace;font-size:.75rem;color:var(--text-primary);display:block;margin-top:.25rem;word-break:break-all}.stats{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;background:var(--bg-secondary);border-radius:8px;font-size:.875rem;color:var(--text-secondary);border:1px solid var(--border)}.stat{font-weight:500}.separator{color:var(--text-tertiary)}.footer{text-align:center;padding:2rem 0;font-size:.875rem;color:var(--text-secondary)}.footer a{color:var(--primary);text-decoration:none;transition:color .15s ease}.footer a:hover{color:var(--primary-hover);text-decoration:underline}@media(max-width:768px){.app{grid-template-columns:1fr}.header h1{font-size:2rem}.container{padding:1rem}}.todo-list::-webkit-scrollbar,.event-list::-webkit-scrollbar{width:8px}.todo-list::-webkit-scrollbar-track,.event-list::-webkit-scrollbar-track{background:var(--bg-secondary);border-radius:4px}.todo-list::-webkit-scrollbar-thumb,.event-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}.todo-list::-webkit-scrollbar-thumb:hover,.event-list::-webkit-scrollbar-thumb:hover{background:var(--text-tertiary)}</style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Ireneo Demo</h1>
            <p class="subtitle">TodoMVC with Mutation Sourcing</p>
        </header>

        <div class="app">
            <!-- Left Panel: Todo List -->
            <div class="panel todos-panel">
                <div class="panel-header">
                    <h2>📝 Todos</h2>
                </div>
                <div class="panel-content">
                    <div class="input-group">
                        <input
                            id="new-todo"
                            type="text"
                            placeholder="What needs to be done?"
                            autocomplete="off"
                        />
                        <button id="add-btn" class="btn btn-primary">Add</button>
                    </div>
                    <ul id="todo-list" class="todo-list"></ul>
                    <div class="actions">
                        <button id="clear-all-btn" class="btn btn-danger">Clear All</button>
                    </div>
                    <div class="auto-save-notice">
                        <small style="color: var(--text-tertiary);">✨ Auto-saves on every change</small>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Event Log -->
            <div class="panel events-panel">
                <div class="panel-header">
                    <h2>📊 Event Log</h2>
                    <span class="subtitle">Live Mutation Tracking</span>
                </div>
                <div class="panel-content">
                    <div id="event-list" class="event-list"></div>
                    <div class="stats">
                        <span id="event-count" class="stat">0 events</span>
                        <span class="separator">•</span>
                        <span id="storage-size" class="stat">0 KB</span>
                        <button id="theme-toggle" class="icon-btn" title="Toggle theme">🌙</button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>
                Powered by <a href="https://github.com/xrrocha/ireneo" target="_blank">Ireneo</a>
                • No server, no database, just JavaScript
                • <a href="../docs/primer.md" target="_blank">Read the Primer</a>
            </p>
        </footer>
    </div>

    <!-- Load main module -->
</body>
</html>
