<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ireneo Demo: TodoMVC with Mutation Sourcing</title>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=n(s);fetch(s.href,i)}})();const oe=(t="ireneo",e="events")=>{let n,r=!1;const s=new Promise((c,o)=>{if(typeof indexedDB>"u"){o(new Error("IndexedDB not available (browser only)"));return}const a=indexedDB.open(t);a.onerror=()=>o(a.error),a.onsuccess=()=>{const l=a.result,f=l.objectStoreNames.contains(e),u=l.version;if(l.close(),f){const d=indexedDB.open(t,u);d.onerror=()=>o(d.error),d.onsuccess=()=>{n=d.result,c()}}else{const d=indexedDB.open(t,u+1);d.onerror=()=>o(d.error),d.onsuccess=()=>{n=d.result,c()},d.onupgradeneeded=_=>{const w=_.target.result;w.objectStoreNames.contains(e)||w.createObjectStore(e,{autoIncrement:!0})}}},a.onupgradeneeded=l=>{const f=l.target.result;f.objectStoreNames.contains(e)||f.createObjectStore(e,{autoIncrement:!0})}}),i=()=>{if(r)throw new Error(`EventLog (${e}) has been closed and cannot be used. This usually happens when switching between memory images.`)};return{append:async c=>(i(),await s,new Promise((o,a)=>{const u=n.transaction([e],"readwrite").objectStore(e).add(c);u.onsuccess=()=>o(),u.onerror=()=>a(u.error)})),getAll:async()=>(i(),await s,new Promise((c,o)=>{const f=n.transaction([e],"readonly").objectStore(e).getAll();f.onsuccess=()=>c(f.result),f.onerror=()=>o(f.error)})),clear:async()=>(i(),await s,new Promise((c,o)=>{const f=n.transaction([e],"readwrite").objectStore(e).clear();f.onsuccess=()=>c(),f.onerror=()=>o(f.error)})),close:async()=>{if(!r){r=!0;try{await s,n&&(n.close(),await new Promise(c=>setTimeout(c,50)))}catch(c){console.warn(`EventLog close(): Database was never initialized (${e})`,c)}}}}};class ie{constructor(){this.delta=new Map,this.DELETED=Symbol("deleted")}getDeletedSymbol(){return this.DELETED}isDirty(){return this.delta.size>0}size(){return this.delta.size}has(e){return this.delta.has(e)}get(e){return this.delta.get(e)}set(e,n){this.delta.set(e,n)}delete(e){this.delta.set(e,this.DELETED)}isDeleted(e){return this.delta.get(e)===this.DELETED}clear(){this.delta.clear()}entries(){return Array.from(this.delta.entries()).sort((e,n)=>{const r=e[0].split(".").length,s=n[0].split(".").length;return r-s})}createCheckpoint(){return new Map(this.delta)}restoreCheckpoint(e){this.delta.clear();for(const[n,r]of e)this.delta.set(n,r)}}function ce(t){return t!==null&&typeof t=="object"}function $(t,e,n=new WeakMap){if(!ce(t))return t;if(n.has(t))return n.get(t);const r=e.has(t)?e.get(t):t;if(r!==t&&n.has(r)){const o=n.get(r);return n.set(t,o),o}if(r instanceof Map){const o=new Map;n.set(t,o),r!==t&&n.set(r,o);let a=!1;for(const[f,u]of r.entries()){const d=$(f,e,n),_=$(u,e,n);o.set(d,_),(d!==f||_!==u)&&(a=!0)}const l=a?o:r;return n.set(t,l),r!==t&&n.set(r,l),l}if(r instanceof Set){const o=new Set;n.set(t,o),r!==t&&n.set(r,o);let a=!1;for(const f of r.values()){const u=$(f,e,n);o.add(u),u!==f&&(a=!0)}const l=a?o:r;return n.set(t,l),r!==t&&n.set(r,l),l}if(Array.isArray(r)){const o=[];n.set(t,o),r!==t&&n.set(r,o);let a=!1;for(const f of r){const u=$(f,e,n);o.push(u),u!==f&&(a=!0)}const l=a?o:r;return n.set(t,l),r!==t&&n.set(r,l),l}const s={};n.set(t,s),r!==t&&n.set(r,s);let i=!1;for(const[o,a]of Object.entries(r)){const l=$(a,e,n);s[o]=l,l!==a&&(i=!0)}const c=i?s:r;return n.set(t,c),r!==t&&n.set(r,c),c}function L(t){return t!==null&&typeof t=="object"}function D(t,e,n,r,s){if(r.has(t))return r.get(t);const i=e.getDeletedSymbol(),c=new Proxy(t,{get(o,a){if(typeof a=="symbol")return o[a];const l=[...n,String(a)],f=l.join(".");if(e.has(f)){const d=e.get(f);return d===i?void 0:L(d)?s.has(d)?d:D(d,e,l,r,s):d}const u=o[a];if(typeof u=="function"&&Array.isArray(o)){const d=String(a);return["push","pop","shift","unshift","splice","sort","reverse"].includes(d)?function(...v){const y=n.join(".");let E;e.has(y)?E=e.get(y):(E=[...o],e.set(y,E));let g=v;return(d==="push"||d==="unshift"||d==="splice")&&(g=v.map((p,m)=>{if(!L(p))return p;if(r.has(p))return r.get(p);if(s.has(p))return p;let R;if(d==="push")R=[...n,String(E.length+m)];else if(d==="unshift")R=[...n,String(m)];else{const O=v[0];if(m<2)return p;R=[...n,String(O+m-2)]}return D(p,e,R,r,s)})),u.apply(E,g)}:["find","findLast","filter","map","flatMap"].includes(d)?function(...v){const y=u.apply(o,v);if(y==null)return y;if(d==="find"||d==="findLast"){if(L(y)){const E=o.indexOf(y);if(E!==-1){const g=[...n,String(E)];return D(y,e,g,r,s)}}return y}else return Array.isArray(y)?y.map((E,g)=>{if(L(E)){const S=o.indexOf(E);if(S!==-1){const p=[...n,String(S)];return D(E,e,p,r,s)}}return E}):y}:u.bind(o)}if(typeof u=="function"&&o instanceof Map){const d=String(a);return["set","delete","clear"].includes(d)?function(...y){if(d==="set"&&y.length>=2){const[E,g]=y,S=[...n,String(E)],p=S.join(".");let m=g;return L(g)&&(r.has(g)?m=r.get(g):s.has(g)||(m=D(g,e,S,r,s))),e.set(p,m),o}if(d==="delete"&&y.length>=1){const[E]=y,S=[...n,String(E)].join(".");return e.delete(S),!0}if(d==="clear"){const E=new Set(o.keys()),g=n.join(".")+".";for(const[S]of e.entries())if(S.startsWith(g)){const p=S.slice(g.length);p.includes(".")||E.add(p)}for(const S of E){const m=[...n,String(S)].join(".");e.delete(m)}return}return u.apply(o,y)}:["get"].includes(d)?function(...y){const[E]=y,g=[...n,String(E)],S=g.join(".");if(e.has(S)){const m=e.get(S);return m===i?void 0:L(m)?r.has(m)?r.get(m):s.has(m)?m:D(m,e,g,r,s):m}const p=o.get(E);return p!=null&&L(p)?r.has(p)?r.get(p):s.has(p)?p:D(p,e,g,r,s):p}:["values","entries","keys","forEach"].includes(d)?function(...y){const E=new Map;for(const[S,p]of o.entries())E.set(S,p);const g=n.join(".")+".";for(const[S,p]of e.entries())if(S.startsWith(g)){const m=S.slice(g.length);if(!m.includes(".")){const R=m;p===i?E.delete(R):E.set(R,p)}}if(d==="forEach"){const[S,p]=y;for(const[m,R]of E.entries()){let O=R;if(L(R)){const U=[...n,String(m)];r.has(R)?O=r.get(R):s.has(R)||(O=D(R,e,U,r,s))}S.call(p,O,m,o)}return}else{let S;return d==="values"?S=E.values():d==="entries"?S=E.entries():S=E.keys(),{[Symbol.iterator](){return this},next(){const p=S.next();if(!p.done&&p.value!==void 0){if(d==="values"){const m=p.value;if(L(m)){let R=null;for(const[O,U]of E.entries())if(U===m){R=O;break}if(R!==null&&!r.has(m)&&!s.has(m)){const O=[...n,String(R)];p.value=D(m,e,O,r,s)}else r.has(m)&&(p.value=r.get(m))}}else if(d==="entries"){const[m,R]=p.value;if(L(R)){if(r.has(R))p.value=[m,r.get(R)];else if(!s.has(R)){const O=[...n,String(m)];p.value=[m,D(R,e,O,r,s)]}}}}return p}}}}:u.bind(o)}if(typeof u=="function"&&o instanceof Set){const d=String(a);return["add","delete","clear"].includes(d)?function(...w){const v=n.join(".");let y;if(e.has(v)?y=e.get(v):(y=new Set(o),e.set(v,y)),d==="add"&&w.length>=1){const g=w[0];if(L(g)&&!r.has(g)&&!s.has(g)){const S=[...n,String(g)];w[0]=D(g,e,S,r,s)}}return u.apply(y,w)}:u.bind(o)}return L(u)?s.has(u)?u:D(u,e,l,r,s):u},set(o,a,l){const u=[...n,String(a)].join(".");return e.set(u,l),!0},has(o,a){const f=[...n,String(a)].join(".");return e.has(f)?e.get(f)!==i:a in o},deleteProperty(o,a){const f=[...n,String(a)].join(".");return e.delete(f),!0},ownKeys(o){const a=Reflect.ownKeys(o),l=n.length>0?n.join(".")+".":"",f=new Set;for(const[d,_]of e.entries())if(d.startsWith(l)){const w=d.slice(l.length),v=w.indexOf("."),y=v===-1?w:w.slice(0,v);_!==i&&f.add(y)}const u=new Set(a);for(const[d,_]of e.entries())if(d.startsWith(l)){const w=d.slice(l.length);if(w.indexOf(".")===-1){const y=w;_===i?u.delete(y):u.add(y)}}return Array.from(u)},getOwnPropertyDescriptor(o,a){const f=[...n,String(a)].join(".");if(e.has(f)){const u=e.get(f);return u===i?void 0:{value:u,writable:!0,enumerable:!0,configurable:!0}}return Reflect.getOwnPropertyDescriptor(o,a)}});return r.set(t,c),s.set(c,t),c}const h={SET:"SET",DELETE:"DELETE",ARRAY_PUSH:"ARRAY_PUSH",ARRAY_POP:"ARRAY_POP",ARRAY_SHIFT:"ARRAY_SHIFT",ARRAY_UNSHIFT:"ARRAY_UNSHIFT",ARRAY_SPLICE:"ARRAY_SPLICE",ARRAY_SORT:"ARRAY_SORT",ARRAY_REVERSE:"ARRAY_REVERSE",ARRAY_FILL:"ARRAY_FILL",ARRAY_COPYWITHIN:"ARRAY_COPYWITHIN",MAP_SET:"MAP_SET",MAP_DELETE:"MAP_DELETE",MAP_CLEAR:"MAP_CLEAR",SET_ADD:"SET_ADD",SET_DELETE:"SET_DELETE",SET_CLEAR:"SET_CLEAR",SCRIPT:"SCRIPT"},B={TYPE:"__type__",CLASS:"__class__",DATE_VALUE:"__dateValue__"};var T=(t=>(t[t.NULL=0]="NULL",t[t.UNDEFINED=1]="UNDEFINED",t[t.PRIMITIVE=2]="PRIMITIVE",t[t.BIGINT=3]="BIGINT",t[t.SYMBOL=4]="SYMBOL",t[t.DATE=5]="DATE",t[t.REGEXP=6]="REGEXP",t[t.FUNCTION=7]="FUNCTION",t[t.ARRAY=8]="ARRAY",t[t.MAP=9]="MAP",t[t.SET=10]="SET",t[t.OBJECT=11]="OBJECT",t))(T||{});function ae(t){if(t===null)return{category:0,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!1};if(t===void 0)return{category:1,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!1};const e=typeof t;return e==="string"||e==="number"||e==="boolean"?{category:2,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!1}:e==="bigint"?{category:3,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!0}:e==="symbol"?{category:4,isPrimitive:!0,isObject:!1,isCollection:!1,needsSpecialSerialization:!0}:t instanceof Date?{category:5,isPrimitive:!1,isObject:!0,isCollection:!1,needsSpecialSerialization:!0}:t instanceof RegExp?{category:6,isPrimitive:!1,isObject:!0,isCollection:!1,needsSpecialSerialization:!0}:e==="function"?{category:7,isPrimitive:!1,isObject:!0,isCollection:!1,needsSpecialSerialization:!0}:Array.isArray(t)?{category:8,isPrimitive:!1,isObject:!0,isCollection:!0,needsSpecialSerialization:!1}:t instanceof Map?{category:9,isPrimitive:!1,isObject:!0,isCollection:!0,needsSpecialSerialization:!0}:t instanceof Set?{category:10,isPrimitive:!1,isObject:!0,isCollection:!0,needsSpecialSerialization:!0}:{category:11,isPrimitive:!1,isObject:!0,isCollection:!1,needsSpecialSerialization:!1}}function le(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return!(e===null||e===Object.prototype||t instanceof Date||t instanceof RegExp||t instanceof Map||t instanceof Set||t instanceof Array||t instanceof Error||ArrayBuffer.isView(t)||t instanceof ArrayBuffer)}function fe(t){const e=Object.getPrototypeOf(t);if(!e||e===Object.prototype)return null;const n=e.constructor;return!n||!n.name?null:n.name}class ue{constructor(e,n){this.targetToPath=e,this.currentPath=n,this.seen=new Map}hasSeen(e){return this.seen.has(e)}markSeen(e,n){this.seen.set(e,n)}getReference(e){const n=this.targetToPath.get(e);return n&&n.length>0&&!(n.length>=this.currentPath.length&&this.currentPath.every((s,i)=>s===n[i]))?{__type__:"ref",path:n}:this.hasSeen(e)?{__type__:"ref",path:this.seen.get(e).slice(this.currentPath.length)}:null}}function z(t,e,n,r){const s=typeof t=="object"&&t!==null&&r.get(t)||t,i=ae(s);switch(i.category){case T.NULL:case T.UNDEFINED:return t;case T.PRIMITIVE:return t;case T.BIGINT:return{[B.TYPE]:"bigint",value:t.toString()};case T.SYMBOL:return{[B.TYPE]:"symbol",description:t.description};case T.DATE:{const c=r.get(t)||t,o=n.getReference(c);if(o)return o;n.markSeen(c,e);const a=c,l=a.getTime(),f=isNaN(l)?null:a.toISOString(),u={[B.TYPE]:"date",[B.DATE_VALUE]:f},d=Object.entries(a);for(const[_,w]of d)u[_]=z(w,[...e,_],n,r);return u}case T.REGEXP:{const c=r.get(t)||t,o=n.getReference(c);if(o)return o;n.markSeen(c,e);const a=c;return{[B.TYPE]:"regexp",source:a.source,flags:a.flags,lastIndex:a.lastIndex}}case T.FUNCTION:{const c=t;return c.__type__==="function"?{[B.TYPE]:"function",sourceCode:c.sourceCode||t.toString()}:void 0}case T.MAP:case T.SET:case T.ARRAY:case T.OBJECT:{const c=r.get(t)||t,o=n.getReference(c);if(o)return o;if(n.markSeen(c,e),i.category===T.MAP)return{[B.TYPE]:"map",entries:Array.from(c.entries()).map(([f,u],d)=>[z(f,[...e,"key",String(d)],n,r),z(u,[...e,"value",String(d)],n,r)])};if(i.category===T.SET)return{[B.TYPE]:"set",values:Array.from(c.values()).map((f,u)=>z(f,[...e,String(u)],n,r))};if(i.category===T.ARRAY)return t.map((f,u)=>z(f,[...e,String(u)],n,r));const a={},l=t;if(le(c)){const f=fe(c);f&&(a[B.CLASS]=f)}for(const f in l)Object.prototype.hasOwnProperty.call(l,f)&&(a[f]=z(l[f],[...e,f],n,r));return a}default:return}}const x=(t,e,n,r)=>{const s=new ue(n,r);return z(t,r,s,e)},de=t=>typeof t=="object"&&t!==null&&"__type__"in t&&typeof t.__type__=="string",G=t=>{const n=new Function(`return (${t.sourceCode})`)();return n.__type__="function",n.sourceCode=t.sourceCode,n},X=(t,e,n)=>{if(!("__dateValue__"in t))throw new Error("Invalid Date serialization format: missing __dateValue__ field");const r=t.__dateValue__,s=r===null?new Date("invalid"):new Date(r);for(const[i,c]of Object.entries(t))i==="__type__"||i==="__dateValue__"||(s[i]=e(c,n));return s},Q=t=>{const e=new RegExp(t.source,t.flags);return t.lastIndex!==void 0&&(e.lastIndex=t.lastIndex),e},Z=t=>BigInt(t.value),ee=t=>Symbol(t.description),N=t=>typeof t=="object"&&t!==null&&"__unresolved_ref__"in t,pe=(t,e)=>{const n=new Map;for(const[r,s]of t.entries){const i=typeof r=="object"&&r!==null&&r.__type__&&H[r.__type__]?.(r,e)||r,c=typeof s=="object"&&s!==null&&s.__type__&&H[s.__type__]?.(s,e)||s;n.set(i,c)}return n},ye=(t,e)=>{const n=new Set;for(const r of t.values){const s=typeof r=="object"&&r!==null&&r.__type__&&H[r.__type__]?.(r,e)||r;n.add(s)}return n},H={function:t=>G(t),date:(t,e)=>X(t,(r,s)=>{if(r&&typeof r=="object"&&"__type__"in r){const i=H[r.__type__];return i?i(r,e):r}return r},e),regexp:t=>Q(t),bigint:t=>Z(t),symbol:t=>ee(t),ref:t=>({__unresolved_ref__:t.path}),map:(t,e)=>pe(t,e),set:(t,e)=>ye(t,e)};function Ee(t,e,n){const r=[];function s(c,o=[]){if(c===null||typeof c!="object")return c;if(c.__type__&&H[c.__type__]){const a=H[c.__type__];if(!a)return c;const l=a(c,t);if(l&&N(l))return r.push({parent:null,key:null,path:l.__unresolved_ref__}),l;if(l instanceof Date){for(const f in l)if(Object.prototype.hasOwnProperty.call(l,f)){const u=l[f];u&&N(u)&&r.push({parent:l,key:f,path:u.__unresolved_ref__})}}return l}for(const a in c)if(Object.prototype.hasOwnProperty.call(c,a)){const l=c[a];if(l&&typeof l=="object")if(l.__type__&&H[l.__type__]){const f=H[l.__type__];if(!f)continue;const u=f(l,t);if(u&&N(u))r.push({parent:c,key:a,path:u.__unresolved_ref__});else if(c[a]=u,u instanceof Date){for(const d in u)if(Object.prototype.hasOwnProperty.call(u,d)){const _=u[d];_&&N(_)&&r.push({parent:u,key:d,path:_.__unresolved_ref__})}}}else{const f=s(l,[...o,a]);f!==l&&(c[a]=f)}}return c}let i=s(t);for(const c of r){const{parent:o,key:a,path:l}=c,f=e(l,i);o&&a!==null?o[a]=f:o===null&&a===null&&(i=f)}return i}function me(t,e,n){return Ee(t,(i,c)=>{let o=c,a=!0;for(const l of i){const f=o?.[l];if(f===void 0){a=!1;break}o=f}if(a)return o;o=e;for(const l of i){const f=o?.[l];if(f===void 0)throw new Error(`Cannot resolve event value ref path: ${i.join(".")} (not found in value scope or memory scope)`);o=f}return o})}const I=(t,e,n=new WeakMap,r)=>{if(t==null||typeof t!="object")return t;if(n.has(t))return n.get(t);if(de(t)){const i=t;switch(i.__type__){case"function":return G(i);case"date":return X(i,(a,l)=>I(a,e,n),e);case"regexp":return Q(i);case"bigint":return Z(i);case"symbol":return ee(i);case"ref":{const c=i;let o=e;for(const a of c.path)if(o=o[a],o===void 0)throw new Error(`Cannot resolve ref path: ${c.path.join(".")}`);return o}case"map":{const c=i,o=new Map;n.set(t,o);for(const[a,l]of c.entries){const f=I(a,e,n),u=I(l,e,n);o.set(f,u)}return o}case"set":{const c=i,o=new Set;n.set(t,o);for(const a of c.values)o.add(I(a,e,n));return o}case"circular":throw new Error("Encountered explicit circular marker - this indicates a serialization issue")}}if(Array.isArray(t)){const i=[];n.set(t,i);for(const c of t)i.push(I(c,e,n));return i}const s={};n.set(t,s);for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(s[i]=I(t[i],e,n));return s};class he{createEvent(e,n,r){const[s]=n;return{type:h.SET,path:e,value:x(s,r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const c=me(e.value,s);n instanceof Map?n.set(r,c):n[r]=c}}class _e{createEvent(e){return{type:h.DELETE,path:e,timestamp:Date.now()}}applyEvent(e,n,r){delete n[r]}}class ge{createEvent(e,n,r){return{type:h.ARRAY_PUSH,path:e,items:n.map(s=>x(s,r.proxyToTarget,r.targetToPath,e)),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,c=n[r];for(const o of i.items)c.push(I(o,s))}}class Se{createEvent(e){return{type:h.ARRAY_POP,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].pop()}}class we{createEvent(e){return{type:h.ARRAY_SHIFT,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].shift()}}class Ae{createEvent(e,n,r){return{type:h.ARRAY_UNSHIFT,path:e,items:n.map(s=>x(s,r.proxyToTarget,r.targetToPath,e)),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,c=n[r],o=i.items.map(a=>I(a,s));c.unshift(...o)}}class ve{createEvent(e,n,r){return{type:h.ARRAY_SPLICE,path:e,start:n[0],deleteCount:n[1]||0,items:n.slice(2).map(s=>x(s,r.proxyToTarget,r.targetToPath,e)),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,c=n[r],o=i.items.map(a=>I(a,s));c.splice(i.start,i.deleteCount,...o)}}class Re{createEvent(e){return{type:h.ARRAY_SORT,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].sort()}}class Pe{createEvent(e){return{type:h.ARRAY_REVERSE,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].reverse()}}class Te{createEvent(e,n,r){return{type:h.ARRAY_FILL,path:e,value:x(n[0],r.proxyToTarget,r.targetToPath,e),start:n[1],end:n[2],timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,c=n[r],o=I(i.value,s);c.fill(o,i.start,i.end)}}class Ie{createEvent(e,n){return{type:h.ARRAY_COPYWITHIN,path:e,target:n[0],start:n[1],end:n[2],timestamp:Date.now()}}applyEvent(e,n,r){const s=e;n[r].copyWithin(s.target,s.start,s.end)}}class De{createEvent(e,n,r){return{type:h.MAP_SET,path:e,key:x(n[0],r.proxyToTarget,r.targetToPath,e),value:x(n[1],r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,c=n[r],o=I(i.key,s),a=I(i.value,s);c.set(o,a)}}class Le{createEvent(e,n,r){return{type:h.MAP_DELETE,path:e,key:x(n[0],r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,c=n[r],o=I(i.key,s);c.delete(o)}}class ke{createEvent(e){return{type:h.MAP_CLEAR,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].clear()}}class Oe{createEvent(e,n,r){return{type:h.SET_ADD,path:e,value:x(n[0],r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,c=n[r],o=I(i.value,s);c.add(o)}}class be{createEvent(e,n,r){return{type:h.SET_DELETE,path:e,value:x(n[0],r.proxyToTarget,r.targetToPath,e),timestamp:Date.now()}}applyEvent(e,n,r,s){const i=e,c=n[r],o=I(i.value,s);c.delete(o)}}class xe{createEvent(e){return{type:h.SET_CLEAR,path:e,timestamp:Date.now()}}applyEvent(e,n,r){n[r].clear()}}class Ye{createEvent(e,n){return{type:h.SCRIPT,path:e,source:n[0],timestamp:Date.now()}}applyEvent(){}}class Be{constructor(){this.handlers=new Map}register(e,n){this.handlers.set(e,n)}createEvent(e,n,r,s){const i=this.handlers.get(e);if(!i)throw new Error(`No handler registered for event type: ${e}`);return i.createEvent(n,r,s)}applyEvent(e,n,r,s){const i=this.handlers.get(e.type);if(!i)throw new Error(`No handler registered for event type: ${e.type}`);i.applyEvent(e,n,r,s)}hasHandler(e){return this.handlers.has(e)}}const P=new Be;P.register(h.SET,new he);P.register(h.DELETE,new _e);P.register(h.ARRAY_PUSH,new ge);P.register(h.ARRAY_POP,new Se);P.register(h.ARRAY_SHIFT,new we);P.register(h.ARRAY_UNSHIFT,new Ae);P.register(h.ARRAY_SPLICE,new ve);P.register(h.ARRAY_SORT,new Re);P.register(h.ARRAY_REVERSE,new Pe);P.register(h.ARRAY_FILL,new Te);P.register(h.ARRAY_COPYWITHIN,new Ie);P.register(h.MAP_SET,new De);P.register(h.MAP_DELETE,new Le);P.register(h.MAP_CLEAR,new ke);P.register(h.SET_ADD,new Oe);P.register(h.SET_DELETE,new be);P.register(h.SET_CLEAR,new xe);P.register(h.SCRIPT,new Ye);function te(t,e,n={}){const{createIntermediates:r=!1}=n;if(e.length===0)return null;if(e.length===1)return{parent:t,key:e[0],exists:!0};let s=t,i=!0;for(let o=0;o<e.length-1;o++){const a=e[o];if(a)if(s instanceof Map){if(!s.has(a))if(r){const l=e[o+1],f=l&&/^\d+$/.test(l)?[]:{};s.set(a,f)}else{i=!1;break}s=s.get(a)}else if(s!==null&&typeof s=="object"){if(!(a in s))if(r){const l=e[o+1];s[a]=l&&/^\d+$/.test(l)?[]:{}}else{i=!1;break}s=s[a]}else{i=!1;break}}const c=e[e.length-1];return{parent:s,key:c,exists:i}}const V=(t,e)=>{const n=te(t,e.path,{createIntermediates:!0});if(!n)return;const{parent:r,key:s}=n;P.applyEvent(e,r,s,t)},W=async(t,e,n)=>{if(n.isReplaying=!0,Array.isArray(e))for(const r of e)V(t,r);else for await(const r of e)V(t,r);n.isReplaying=!1},He=async(t,e,n)=>{if(e.stream)await W(t,e.stream(),n);else{const r=await e.getAll();await W(t,r,n)}};async function K(t){const e=new ie,n=e.getDeletedSymbol(),r=new WeakMap,s=new WeakMap,i={};return await He(i,t,{isReplaying:!0}),{root:D(i,e,[],r,s),isDirty(){return e.isDirty()},getUncommittedCount(){return e.size()},async save(){const o=e.entries(),a=new WeakMap,l=(f,u,d=[])=>{if(!(u===null||typeof u!="object")&&!f.has(u))if(f.set(u,d),Array.isArray(u))u.forEach((_,w)=>l(f,_,[...d,String(w)]));else if(u instanceof Map){let _=0;u.forEach(w=>l(f,w,[...d,`map:${_++}`]))}else if(u instanceof Set){let _=0;u.forEach(w=>l(f,w,[...d,`set:${_++}`]))}else u instanceof Date||Object.entries(u).forEach(([_,w])=>l(f,w,[...d,_]))};for(const[f,u]of o){const d=new WeakMap;l(d,i);const _=f.split("."),w=te(i,_,{createIntermediates:!1});if(!w)continue;const{parent:v,key:y}=w;if(u===n)v instanceof Map||v instanceof Set?v.delete(y):v!==null&&typeof v=="object"&&delete v[y],await t.append({type:"DELETE",path:_,timestamp:Date.now()});else{const E=$(u,s,a),g=x(E,new WeakMap,d,_);v instanceof Map?v.set(y,E):v!==null&&typeof v=="object"&&(v[y]=E),await t.append({type:"SET",path:_,value:g,timestamp:Date.now()})}}e.clear()},discard(){e.clear()},createCheckpoint(){return e.createCheckpoint()},restoreCheckpoint(o){e.restoreCheckpoint(o)},unwrap(o){return $(o,s)}}}let k,b,A;async function J(){try{k=oe("ireneo-demo","todos"),b=await K(k),A=b.root,A.todos||(A.todos=[],A.nextId=1);const t=localStorage.getItem("ireneo-demo-theme")||"light";document.documentElement.setAttribute("data-theme",t),se(t),Ve(),await M(),console.log("Ireneo demo initialized"),console.log(`Loaded ${A.todos.length} todos from IndexedDB`)}catch(t){console.error("Initialization error:",t),alert("Failed to initialize app. Check console for details.")}}async function q(t){if(!t.trim())return;A.todos.push({id:A.nextId++,text:t.trim(),done:!1,createdAt:new Date}),await j();const e=document.getElementById("new-todo");e&&(e.value=""),await M()}async function ze(t){const e=A.todos.find(n=>n.id===t);e&&(e.done=!e.done,await j(),await M())}async function $e(t){const e=A.todos.findIndex(n=>n.id===t);e>=0&&(A.todos.splice(e,1),await j(),await M())}async function j(){try{await b.save(),Y("Saved to IndexedDB","success")}catch(t){console.error("Save error:",t),Y("Save failed","error")}}async function Me(){if(confirm("Clear all todos and events? This cannot be undone."))try{A.todos.length=0,A.nextId=1,await b.save(),k.clear&&await k.clear(),b=await K(k),A=b.root,A.todos=[],A.nextId=1,await M(),Y("All data cleared","success")}catch(t){console.error("Clear error:",t),Y("Clear failed","error")}}function ne(t,e){const n=JSON.stringify(t,null,2),r=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(r),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}function re(){const t=new Date,e=t.getFullYear(),n=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),s=String(t.getHours()).padStart(2,"0"),i=String(t.getMinutes()).padStart(2,"0"),c=String(t.getSeconds()).padStart(2,"0");return`${e}-${n}-${r}-${s}${i}${c}`}async function Ne(){try{const t={todos:A.todos.map(n=>({id:n.id,text:n.text,done:n.done,createdAt:n.createdAt.toISOString()})),nextId:A.nextId},e=`snapshot-${re()}.json`;ne(t,e),Y("Snapshot exported successfully","success")}catch(t){console.error("Export snapshot error:",t),Y("Snapshot export failed","error")}}async function Ke(){try{const t=await k.getAll(),e=`event-log-${re()}.json`;ne(t,e),Y(`Exported ${t.length} events`,"success")}catch(t){console.error("Export log error:",t),Y("Log export failed","error")}}async function Fe(){const t=document.getElementById("log-file-input");t&&(t.value="",t.click(),t.onchange=async()=>{const e=t.files?.[0];if(e)try{const n=await e.text(),r=JSON.parse(n);if(!Array.isArray(r))throw new Error("Invalid event log format: expected an array");if(!confirm(`Import ${r.length} events from "${e.name}"?`))return;const i=confirm(`How should we import?

Click OK to REPLACE all existing data (clears current todos).
Click Cancel to MERGE (keeps current todos, adds imported events).`);i&&(A.todos.length=0,A.nextId=1,await b.save(),k.clear&&await k.clear(),b=await K(k),A=b.root,A.todos=[],A.nextId=1);for(const c of r)await k.append(c);b=await K(k),A=b.root,A.todos||(A.todos=[],A.nextId=1),await M(),Y(`Imported ${r.length} events (${i?"replaced":"merged"})`,"success")}catch(n){console.error("Import log error:",n),Y("Log import failed: "+(n instanceof Error?n.message:"unknown error"),"error"),alert("Failed to import log. Check console for details.")}})}async function M(){Ue(),await je()}function Ue(){const t=document.getElementById("todo-list");if(t){if(A.todos.length===0){t.innerHTML='<li class="empty-state" style="text-align: center; color: var(--text-tertiary); padding: 2rem;">No todos yet. Add one above!</li>';return}t.innerHTML=A.todos.map(e=>`
    <li class="todo-item ${e.done?"done":""}">
      <input
        type="checkbox"
        ${e.done?"checked":""}
        onchange="window.toggleTodoAsync(${e.id})"
      />
      <span class="todo-text">${F(e.text)}</span>
      <button class="todo-delete" onclick="window.deleteTodoAsync(${e.id})" title="Delete">×</button>
    </li>
  `).join("")}}async function je(){const t=document.getElementById("event-list"),e=document.getElementById("event-count"),n=document.getElementById("storage-size");if(!(!t||!e||!n))try{const r=await k.getAll();if(r.length===0){t.innerHTML='<div class="empty-state" style="text-align: center; color: var(--text-tertiary); padding: 2rem;">No events yet. Interact with todos to see mutations!</div>',e.textContent="0 events",n.textContent="0 KB";return}const s=r.slice(-50).reverse();t.innerHTML=s.map(o=>{const a=JSON.stringify(o.path);let l="";return o.type==="SET"&&"value"in o?l=`<div class="event-value">value: ${C(o.value)}</div>`:o.type==="ARRAY_PUSH"&&"items"in o?l=`<div class="event-value">pushed: ${C(o.items[0])}</div>`:o.type==="ARRAY_SPLICE"&&"start"in o&&(l=`<div class="event-value">index: ${o.start}, deleted: ${o.deleteCount}</div>`),`
        <div class="event event-${o.type}">
          <span class="event-type">${o.type}</span>
          <div class="event-path">${F(a)}</div>
          ${l}
        </div>
      `}).join(""),e.textContent=`${r.length} event${r.length!==1?"s":""}`;const c=(JSON.stringify(r).length/1024).toFixed(1);n.textContent=`${c} KB`}catch(r){console.error("Error rendering events:",r),t.innerHTML='<div style="color: var(--danger); padding: 1rem;">Error loading events</div>'}}function Ve(){const t=document.getElementById("add-btn"),e=document.getElementById("new-todo");t&&e&&(t.addEventListener("click",()=>{q(e.value).catch(console.error)}),e.addEventListener("keypress",o=>{o.key==="Enter"&&q(e.value).catch(console.error)}));const n=document.getElementById("clear-all-btn");n&&n.addEventListener("click",Me);const r=document.getElementById("theme-toggle");r&&r.addEventListener("click",We);const s=document.getElementById("export-snapshot-btn");s&&s.addEventListener("click",()=>{Ne().catch(console.error)});const i=document.getElementById("export-log-btn");i&&i.addEventListener("click",()=>{Ke().catch(console.error)});const c=document.getElementById("import-log-btn");c&&c.addEventListener("click",()=>{Fe().catch(console.error)}),window.toggleTodoAsync=o=>ze(o).catch(console.error),window.deleteTodoAsync=o=>$e(o).catch(console.error)}function We(){const e=(document.documentElement.getAttribute("data-theme")||"light")==="light"?"dark":"light";document.documentElement.setAttribute("data-theme",e),localStorage.setItem("ireneo-demo-theme",e),se(e)}function se(t){const e=document.getElementById("theme-toggle");e&&(e.textContent=t==="light"?"🌙":"☀️")}function F(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function C(t){return typeof t=="string"?`"${F(t)}"`:F(JSON.stringify(t,null,2))}function Y(t,e){console.log(`[${e.toUpperCase()}] ${t}`)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",J):J();</script>
  <style rel="stylesheet" crossorigin>:root{--primary: #4F46E5;--primary-hover: #4338CA;--success: #10B981;--warning: #F59E0B;--danger: #EF4444;--bg-primary: #FFFFFF;--bg-secondary: #F9FAFB;--bg-tertiary: #F3F4F6;--text-primary: #111827;--text-secondary: #6B7280;--text-tertiary: #9CA3AF;--border: #E5E7EB;--border-focus: #4F46E5;--event-push-bg: #D1FAE5;--event-push-border: #10B981;--event-set-bg: #FED7AA;--event-set-border: #F59E0B;--event-delete-bg: #FECACA;--event-delete-border: #EF4444;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .05);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .1);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .1)}[data-theme=dark]{--bg-primary: #1F2937;--bg-secondary: #111827;--bg-tertiary: #374151;--text-primary: #F9FAFB;--text-secondary: #D1D5DB;--text-tertiary: #9CA3AF;--border: #374151;--border-focus: #6366F1;--event-push-bg: #065F46;--event-push-border: #10B981;--event-set-bg: #78350F;--event-set-border: #F59E0B;--event-delete-bg: #7F1D1D;--event-delete-border: #EF4444;--shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, .3);--shadow-md: 0 4px 6px -1px rgba(0, 0, 0, .4);--shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, .5)}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;font-size:16px;line-height:1.5;color:var(--text-primary);background:var(--bg-secondary);transition:background-color .2s ease,color .2s ease}.container{max-width:1400px;margin:0 auto;padding:2rem 1.5rem}.header{text-align:center;margin-bottom:2rem}.header h1{font-size:2.5rem;font-weight:700;color:var(--text-primary);margin-bottom:.5rem}.header .subtitle{font-size:1rem;color:var(--text-secondary)}.app{display:grid;grid-template-columns:1fr 1fr;gap:2rem;margin-bottom:2rem}.panel{background:var(--bg-primary);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-md);overflow:hidden;display:flex;flex-direction:column;height:calc(100vh - 300px);min-height:500px;max-height:700px}.panel-header{padding:1.5rem;border-bottom:1px solid var(--border);background:var(--bg-secondary)}.panel-header h2{font-size:1.25rem;font-weight:600;color:var(--text-primary);margin:0}.panel-header .subtitle{font-size:.875rem;color:var(--text-secondary);margin-top:.25rem}.panel-body{flex:1;display:flex;flex-direction:column;overflow:hidden;padding:1.5rem}.scrollable-content{flex:1;overflow-y:auto;display:flex;flex-direction:column}.panel-footer{padding:1.5rem;border-top:1px solid var(--border);background:var(--bg-secondary)}.input-group{display:flex;gap:.5rem;margin-bottom:1.5rem}#new-todo{flex:1;padding:.75rem 1rem;font-size:1rem;border:1px solid var(--border);border-radius:8px;background:var(--bg-primary);color:var(--text-primary);transition:border-color .15s ease,box-shadow .15s ease}#new-todo:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px #4f46e51a}#new-todo::placeholder{color:var(--text-tertiary)}.btn{padding:.75rem 1.25rem;font-size:.875rem;font-weight:500;border:none;border-radius:8px;cursor:pointer;transition:all .15s ease;white-space:nowrap}.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-hover);transform:translateY(-1px);box-shadow:var(--shadow-md)}.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border)}.btn-secondary:hover{background:var(--bg-secondary);transform:translateY(-1px)}.btn-success{background:var(--success);color:#fff}.btn-success:hover{background:#059669;transform:translateY(-1px)}.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#dc2626;transform:translateY(-1px)}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}.icon-btn{background:none;border:none;font-size:1.25rem;cursor:pointer;padding:.25rem .5rem;transition:transform .15s ease}.icon-btn:hover{transform:scale(1.1)}.todo-list{list-style:none}.todo-item{display:flex;align-items:center;gap:.75rem;padding:.875rem;border-radius:8px;background:var(--bg-secondary);border:1px solid var(--border);margin-bottom:.5rem;transition:all .15s ease}.todo-item:hover{border-color:var(--primary);box-shadow:var(--shadow-sm)}.todo-item.done .todo-text{text-decoration:line-through;color:var(--text-tertiary)}.todo-item input[type=checkbox]{width:1.25rem;height:1.25rem;cursor:pointer;accent-color:var(--primary)}.todo-text{flex:1;color:var(--text-primary);font-size:.9375rem}.todo-delete{background:var(--danger);color:#fff;border:none;border-radius:4px;width:1.75rem;height:1.75rem;font-size:1.125rem;line-height:1;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s ease}.todo-delete:hover{background:#dc2626;transform:scale(1.1)}.actions{display:flex;gap:.5rem;flex-wrap:wrap}.auto-save-notice{margin-top:.75rem;text-align:center}.event-list{display:flex;flex-direction:column;gap:.5rem}.event{padding:.75rem 1rem;border-radius:6px;border-left:3px solid;font-size:.875rem;animation:slideIn .3s ease}@keyframes slideIn{0%{opacity:0;transform:translate(-10px)}to{opacity:1;transform:translate(0)}}.event-ARRAY_PUSH{background:var(--event-push-bg);border-color:var(--event-push-border)}.event-SET{background:var(--event-set-bg);border-color:var(--event-set-border)}.event-ARRAY_SPLICE,.event-DELETE{background:var(--event-delete-bg);border-color:var(--event-delete-border)}.event-type{font-weight:600;font-family:Monaco,Courier New,monospace;font-size:.8125rem;display:inline-block;margin-right:.5rem}.event-path{font-family:Monaco,Courier New,monospace;font-size:.75rem;color:var(--text-secondary);display:block;margin-top:.25rem;word-break:break-all}.event-value{font-family:Monaco,Courier New,monospace;font-size:.75rem;color:var(--text-primary);display:block;margin-top:.25rem;word-break:break-all}.stats{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;background:var(--bg-secondary);border-radius:8px;font-size:.875rem;color:var(--text-secondary);border:1px solid var(--border)}.stat{font-weight:500}.separator{color:var(--text-tertiary)}.footer{text-align:center;padding:2rem 0;font-size:.875rem;color:var(--text-secondary)}.footer a{color:var(--primary);text-decoration:none;transition:color .15s ease}.footer a:hover{color:var(--primary-hover);text-decoration:underline}@media(max-width:768px){.app{grid-template-columns:1fr}.header h1{font-size:2rem}.container{padding:1rem}}.scrollable-content::-webkit-scrollbar{width:8px}.scrollable-content::-webkit-scrollbar-track{background:var(--bg-secondary);border-radius:4px}.scrollable-content::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}.scrollable-content::-webkit-scrollbar-thumb:hover{background:var(--text-tertiary)}</style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Ireneo Demo</h1>
            <p class="subtitle">TodoMVC with Mutation Sourcing</p>
        </header>

        <div class="app">
            <!-- Left Panel: Todo List -->
            <div class="panel todos-panel">
                <div class="panel-header">
                    <h2>📝 Todos</h2>
                </div>
                <div class="panel-body">
                    <div class="input-group">
                        <input
                            id="new-todo"
                            type="text"
                            placeholder="What needs to be done?"
                            autocomplete="off"
                        />
                        <button id="add-btn" class="btn btn-primary">Add</button>
                    </div>
                    <div class="scrollable-content">
                        <ul id="todo-list" class="todo-list"></ul>
                    </div>
                </div>
                <div class="panel-footer">
                    <button id="export-snapshot-btn" class="btn btn-secondary">📸 Export Snapshot</button>
                    <button id="clear-all-btn" class="btn btn-danger">Clear All</button>
                    <div class="auto-save-notice">
                        <small style="color: var(--text-tertiary);">✨ Auto-saves on every change</small>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Event Log -->
            <div class="panel events-panel">
                <div class="panel-header">
                    <h2>📊 Event Log</h2>
                    <span class="subtitle">Live Mutation Tracking</span>
                </div>
                <div class="panel-body">
                    <div class="scrollable-content">
                        <div id="event-list" class="event-list"></div>
                    </div>
                </div>
                <div class="panel-footer">
                    <div class="stats">
                        <span id="event-count" class="stat">0 events</span>
                        <span class="separator">•</span>
                        <span id="storage-size" class="stat">0 KB</span>
                        <button id="export-log-btn" class="btn btn-secondary btn-sm">📤 Export</button>
                        <button id="import-log-btn" class="btn btn-secondary btn-sm">📥 Import</button>
                        <button id="theme-toggle" class="icon-btn" title="Toggle theme">🌙</button>
                    </div>
                    <input type="file" id="log-file-input" accept=".json" style="display: none;">
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>
                Powered by <a href="https://github.com/xrrocha/ireneo" target="_blank">Ireneo</a>
                • No server, no database, just JavaScript
                • <a href="https://github.com/xrrocha/ireneo/blob/main/docs/primer.md" target="_blank">Read the Primer</a>
            </p>
        </footer>
    </div>

    <!-- Load main module -->
</body>
</html>
